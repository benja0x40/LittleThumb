# HOST/SCRIPT INFORMATION ######################################################

# =============================================================================.
#
# -----------------------------------------------------------------------------.
host_name <- function() {
  as.character(Sys.info()["nodename"])
}
# =============================================================================.
#
# -----------------------------------------------------------------------------.
cmd_name <- function() {
  cmd <- commandArgs()
  cmd <- basename(cmd[grepl("^--file=", cmd, perl = T)])
  cmd
}
# =============================================================================.
#
# -----------------------------------------------------------------------------.
cmd_args <- function() {
  paste(commandArgs(trailingOnly = T), collapse = " ")
}
# =============================================================================.
#
# -----------------------------------------------------------------------------.
cmd_line <- function() {
  paste(cmd_name(), cmd_args())
}
# =============================================================================.
#
# -----------------------------------------------------------------------------.
exec_path <- function() {
  paste0(inst("LittleThumb"), "/exec")
}
# =============================================================================.
#
# -----------------------------------------------------------------------------.
modules_path <- function() {
  paste0(inst("LittleThumb"), "/modules")
}
# =============================================================================.
#
# -----------------------------------------------------------------------------.
home_path <- function() {
  as.character(Sys.getenv()["HOME"])
}

# EXECUTION ####################################################################

# =============================================================================.
#
# -----------------------------------------------------------------------------.
confirm_execution <- function() {
  cat("Proceed [y/n]? ")
  x <- readLines(file("stdin"), 1)
  if(! grepl("^(y|yes)$", x, perl = T, ignore.case = T)) {
    cat("\nCancelled\n")
    quit()
  }
}
# =============================================================================.
#
# -----------------------------------------------------------------------------.
job_identifier <- function(tag = "job_") {
  basename(tempfile(pattern = tag))
}
# =============================================================================.
#
# -----------------------------------------------------------------------------.
timepoint <- function(x) {
  x <- format(round(difftime(Sys.time(), x, units = "auto"), 2))
  x <- gsub("Time difference of ", "", x)
  x
}
# =============================================================================.
#
# -----------------------------------------------------------------------------.
execute <- function(x, ...) {
  all(sapply(x, system, ...) == 0)
}

# LOG/MESSAGES #################################################################

# =============================================================================.
#
# -----------------------------------------------------------------------------.
print_options <- function(opt, args, lbl) {
  k <- names(opt)
  v <- as.vector(unlist(opt))
  k <- str_pad(k, max(nchar(k)), side = "right", pad = " ")
  cat("Parameters:\n")
  cat(paste(paste0("  ", k, " = ", v), collpase = "\n"), sep = "")
  cat(paste0(lbl, ":\n"))
  cat(paste0("  ", paste(args, collapse = " "), "\n"))
}
# =============================================================================.
#
# -----------------------------------------------------------------------------.
log_file <- function(d = ".") {
  f <- paste(
    cmd_name(),
    format(STARTTIME, "%d.%m.%Y"), format(STARTTIME, "%Hh%Mm%S"), JOBID,
    sep = "_"
  )
  system(paste("mkdir -p", d))
  file(paste0(d, "/", f, ".txt"), open = "w")
}
# =============================================================================.
#
# -----------------------------------------------------------------------------.
str_line <- function(x = "-", n = 80, begin = "", end = "", sep = "") {
  n <- n - (nchar(begin) + nchar(end) + nchar(sep))
  if(n < 0) n <- 0
  if(x != "") {
    str <- paste0(begin, str_pad("", n, pad = x), paste0(end), sep = sep)
  } else {
    str <- paste0(begin, paste0(end), sep = sep)
  }
}
# =============================================================================.
#
# -----------------------------------------------------------------------------.
msg_line <- function(x = "-", n = 80, begin = "", end = "", sep = "", ...) {
  n <- n - (nchar(begin) + nchar(end) + nchar(sep))
  if(n < 0) n <- 0
  if(x != "") {
    cat(begin, str_pad("", n, pad = x), paste0(end, "\n"), sep = sep, ...)
  } else {
    cat(begin, paste0(end, "\n"), sep = sep, ...)
  }
}
# =============================================================================.
#
# -----------------------------------------------------------------------------.
msg_header <- function(tag, ...) {
  msg_line("=", begin = "# ", ...)
  cat("# [ ", tag, " ] ", cmd_line(), "\n", sep = "", ...)
  msg_line("-", begin = "# ", ...)
  msg_line("", ...)
}
# =============================================================================.
#
# -----------------------------------------------------------------------------.
msg_command <- function(cmd = NULL, comment = NULL, chrono = T, status = NULL) {
  if(! is.null(comment)) {
    writeLines(paste("#", comment), CMDFILE)
    if(VERBOSE) cat(paste0(comment, "...\n"))
  }
  if(! is.null(cmd)) writeLines(cmd, CMDFILE)
  if(! is.null(status)) {
    writeLines(paste0("# (completion = ", format(status), ")"), CMDFILE)
  }
  if(chrono) {
    writeLines(paste0("# (time = ", timepoint(STARTTIME), ")"), CMDFILE)
  }
  writeLines("", CMDFILE)
  flush(CMDFILE)
}
