# COLUMNS ######################################################################

# =============================================================================.
#
# -----------------------------------------------------------------------------.
md_tag <- function(x, asis = F, sep = ".", pre = "^", perl = T, ignore.case = F) {
  if(asis) sep <- pre <- ""
  list(
    tag  = x,
    sep  = sep,
    rex  = paste0(pre, x),
    perl = perl, ignore.case = ignore.case
  )
}
# =============================================================================.
#
# -----------------------------------------------------------------------------.
md_def <- function(x, n, ...) {
  if(is.character(x)) x <- md_tag(x, ...)
  if(n > 1) n <- paste0(x$sep, 1:n) else n <- ""
  paste0(x$tag, n)
}
# =============================================================================.
#
# -----------------------------------------------------------------------------.
md_chk <- function(x, obj, ...) {
  if(is.character(x)) x <- md_tag(x, ...)
  grepl(x$rex, names(obj), perl = x$perl, ignore.case = x$ignore.case)
}
# =============================================================================.
#
# -----------------------------------------------------------------------------.
md_tst <- function(x, obj, ...) {
  any(md_chk(x, obj, ...))
}
# =============================================================================.
#
# -----------------------------------------------------------------------------.
md_nbr <- function(x, obj, ...) {
  sum(md_chk(x, obj, ...))
}
# =============================================================================.
#
# -----------------------------------------------------------------------------.
md_lst <- function(x, obj, as.index = F, ...) {
  k <- which(md_chk(x, obj, ...))
  if(! as.index) k <- names(obj)[k]
  k
}
# =============================================================================.
#
# -----------------------------------------------------------------------------.
md_set <- function(x, obj, values = NULL, ...) {
  if(is.character(x)) x <- md_tag(x, ...)
  if(length(values) > 0) {
    chk <- md_chk(x, obj)
    obj <- obj[, ! chk]
    if(VERBOSE & any(chk)) message("Override ", x$tag)
    for(idx in md_def(x, length(values))) {
      obj[[idx]] <- values[1]
      values <- values[-1]
    }
  }
  obj
}

# ROWS #########################################################################

# =============================================================================.
#
# -----------------------------------------------------------------------------.
filter_samples <- function(x, f) {
  rex <- "^([^=]+)=([^=]+)$"
  lst <- unlist(str_split(f, ","))
  chk <- rep(T, nrow(x))
  for(f in lst) {
    k <- make.names(gsub(rex, "\\1", f))
    v <- gsub(rex, "\\2", f)
    if(k %in% colnames(x)) {
      chk <- chk & x[, k] == v
    } else {
      warning(k, " not found in meta data")
    }
  }
  chk <- rownames(x)[chk]
  x <- x[chk, ]
  x
}
