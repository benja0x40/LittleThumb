---
title: "LittleThumb documentation"
subtitle: "`r paste('Package version', packageVersion('LittleThumb'), '-', format(Sys.time(), '%d.%m.%Y'))`"
author: '[Benjamin Leblanc](https://github.com/benja0x40)'
vignette: >
  %\VignetteIndexEntry{LittleThumb documentation}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
fontsize: 11pt
output:
  rmarkdown::html_vignette:
    number_sections: false
    toc: true
    toc_depth: 2
---

```{r message=FALSE, include=FALSE}
library(LittleThumb)

# Reset
rm(list = objects())
unlink("AutoSaved", recursive = T)

cfg <- LittleThumb()
```

### Installation

Run the `R` code below to install `LittleThumb`.

```R
library("devtools") # (devtools can be installed from CRAN repositories)
install_github("benja0x40/LittleThumb")
```

### Introduction

Using LittleThumb should be helpful during the development of scripts
or notebooks involving heterogeneous and time consuming data importation or
processing tasks.

### Basic principles

An R script or notebook based on LittleThumb is structured by series of 3
consecutive sections.

  1. Configuration of global options using the `LittleThumb` function
  2. Definition of R objects using the `MakeObj` function
  3. Anything else depending on the defined R objects

A recommended practice is to use the configuration section only once, 
at the begining of the script or notebook, such that any change in this section
can affect all R objects subsequently defined with the `MakeObj` function.

Each time any R code including the `MakeObj` function is executed, the objects
defined using this function are automatically generated and saved, or loaded,
according to current options and depending on objects availability in the R
environment and at their storage location.

During these executions, LittleThumb produces messages indicating the status
of operations performed automatically for the corresponding objects.

Here is a minimalistic example of R script defining a single persistent object
named `xyz`.

```{r mini_script, eval=FALSE}
# MiniScript.R

library(LittleThumb)

# 1. Configure global options --------------------------------------------------

# Here we choose the default location for automatically saved RDS files
LittleThumb(rootpath = "AutoSaved")

# 2. Define persistent R objects -----------------------------------------------

MakeObj(xyz, {

  # Here we compute the value of the object
  xyz <- 0

})

# 3. Do anything with defined R objects ----------------------------------------

print(xyz)
```

Let's run `MiniScript.R` for the very first time and see the resulting messages.

```{r eval=FALSE}
source("MiniScript.R") # First execution
```
```{r eval=TRUE, message=TRUE, echo=FALSE, results='hide', ref.label='mini_script'}
```

These messages indicate that during this first execution of `MiniScript.R`,
the `AutoSaved` folder has been created in the current directory and 
the `xyz` object has been saved as `AutoSaved/xyz.rds`.

From now on, as long as the `xyz` object remains available in the R environment
and the global options are not changed, the `MakeObj(xyz, ...)` function call
in `MiniScript.R` will bypass operations related to `xyz`.

Let's run `MiniScript.R` a second time and see the resulting messages.

```{r eval=FALSE}
source("MiniScript.R") # Second execution
```
```{r eval=TRUE, message=TRUE, echo=FALSE, results='hide', ref.label='mini_script'}
```

If we execute the script once again but when `xyz` is no longer available,
for instance after restarting the R environment, the `MakeObj(xyz, ...)`
function call will automatically load `xyz` from the `AutoSaved/xyz.rds` file
instead of recomputing this object from scratch.

Let's simulate a loss of the object `xyz` due to restarting the R environment.

```{r}
rm(xyz)
```

And then let's run `MiniScript.R` once again to see the resulting messages.

```{r eval=FALSE}
source("MiniScript.R") # Another execution after loss of 'xyz'
```
```{r eval=TRUE, message=TRUE, echo=FALSE, results='hide', ref.label='mini_script'}
```

### Automation options

Automation options can be modified using the `LittleThumb` function. Two
important options are `reload` and `rebuild`.
The `reload` option controls whether objects should be reloaded when
they are already available in the R environment.
The `rebuild` option controls whether objects should be regenerated and saved
when their associated RDS file is already available at its expected location.

```{r}
LittleThumb(reload = "xyz")
```
```{r eval=FALSE}
source("MiniScript.R") # Another execution after loss of 'xyz'
```
```{r eval=TRUE, message=TRUE, echo=FALSE, results='hide', ref.label='mini_script'}
```

```{r}
LittleThumb(rebuild = "xyz")
```
```{r eval=FALSE}
source("MiniScript.R") # Another execution after loss of 'xyz'
```
```{r eval=TRUE, message=TRUE, echo=FALSE, results='hide', ref.label='mini_script'}
```

### Advance usage

We want to compute two R objects.
The first one (`dna`) will be a list containing DNA sequences.
The second one (`graphs`) will be an environment containing a graphic
representation of each DNA sequence, in the form of numeric matrixes composed
of two columns corresponding to `x` and `y` coordinates.

First we implement the function `SimSeq` which naively simulates random DNA
sequences with a specified GC-content.

```{r}
# Naive DNA sequence simulation
SimSeq <- function(n, l, gc = 0.4) {

  a <- factor(c("A", "C", "G", "T"))
  p <- c(1 - gc, gc, gc, 1 - gc) / 2
  
  s <- replicate(n, sample(a, size = l, replace = T, prob = p), simplify = F)
  names(s) <- paste0("S", 1:n)
  
  s
}
```

Then we implement the function `CGR` which calculates the
[Chaos Game Representation](https://www.ncbi.nlm.nih.gov/pubmed/2336393)
of a given DNA sequence.

```{r}
# Chaos Game Representation of DNA
CGR <- function(s) {

  s <- as.numeric(s)

  x <- c(-1, -1,  1,  1)[s]
  y <- c(-1,  1,  1, -1)[s]
  
  for(i in 2:length(s)) {
    x[i] <- (x[i - 1] + x[i]) / 2
    y[i] <- (y[i - 1] + y[i]) / 2
  }
  
  cbind(x, y)
}
```

Now we configure the global options of our script.

```{r}
# Here we choose the default location for automatically saved RDS files
LittleThumb(rootpath = "AutoSaved")

# We use specific paths for contained objects
cache <- list(
  dna    = "contents/dna",
  graphs = "contents/graphs"
)
```

We define the `dna` object.

```{r make_dna, eval=FALSE}
MakeObj(dna, {
  
  # Initialize dna as a list specifying the length and number of DNA sequences
  dna <- list(s_len = 10000, s_nbr = 4) 

  MakeObj(sequences, path = cache$dna, {
    sequences <- with(dna, SimSeq(s_nbr, s_len))
  })
  
  AssignObj(sequences, to = dna)
})
```

We define the `graphs` object.

```{r make_graphs, eval=FALSE}
MakeObj(graphs, {

  # Initialize graphs as an empty environment
  graphs <- new.env()

  for(i in 1:dna$s_nbr) {
    
    obj <- names(dna$sequences[i])
    
    MakeObj(name = obj, path = cache$graphs, envir = graphs, rebuild = T, {
      m <- CGR(dna$sequences[[i]])
      AssignObj(m, name = obj)
    })
  }
})
```

Whe run for the first time, the section defining the `dna` object will produce
the following messages.

```{r eval=TRUE, message=TRUE, echo=FALSE, results='hide', ref.label='make_dna'}
```

Whe run for the first time, the section defining the `dna` object will produce
the following messages.

```{r eval=TRUE, message=TRUE, echo=FALSE, results='hide', ref.label='make_graphs'}
```

### Repeated script execution using MakeObj

#### Basics

A very simple script named `LT_Test.R`.

```{r script, eval=FALSE}
library(LittleThumb)

LittleThumb(rootpath = "AutoSaved")

MakeObj(x, {
  message("building object x...")
  x <- pi
})
```

First time execution.

```{r eval=FALSE}
source("LT_Test.R")
```
```{r eval=TRUE, message=TRUE, echo=FALSE, results='hide', ref.label='script'}
```

Second time execution without restarting the R environment.

```{r eval=FALSE}
source("LT_Test.R")
```
```{r eval=TRUE, message=TRUE, echo=FALSE, results='hide', ref.label='script'}
```

Second time execution after restarting the R environment.

```{r include=FALSE}
# Simulate restarting the R environment
do.call(LittleThumb, cfg) # Restore default options
suppressWarnings(rm(x))   # Cleanup
```

```{r eval=FALSE}
source("LT_Test.R")
```
```{r eval=TRUE, message=TRUE, echo=FALSE, results='hide', ref.label='script'}
```

#### Forcing to reload R objects

```{r include=FALSE}
x <- 0
```

By default, R object are loaded only if necessary.

```{r eval=FALSE}
x <- 0
source("LT_Test.R")
```
```{r eval=TRUE, message=FALSE, echo=FALSE, results='hide', ref.label='script'}
```

```{r}
print(x)
```

Can be done by changing the `reload` global option.

```{r script_reload, eval=FALSE}
library(LittleThumb)

LittleThumb(rootpath = "AutoSaved")
LittleThumb(reload = T)

MakeObj(x, {
  message("building object x...")
  x <- pi
})
```

Can be done by specifying the `reload` argument when calling `MakeObj`.

```{r eval=FALSE}
library(LittleThumb)

LittleThumb(rootpath = "AutoSaved")

MakeObj(x, reload = T, {
  message("building object x...")
  x <- pi
})
```

Second time execution when forcing to reload the R object.

```{r eval=FALSE}
source("LT_Test.R")
```
```{r eval=TRUE, message=TRUE, echo=FALSE, results='hide', ref.label='script_reload'}
```

```{r}
print(x)
```

```{r include=FALSE}
do.call(LittleThumb, cfg) # Restore default options
```

#### Forcing to rebuild R objects

```{r}
MakeObj(x, { x <- 2 * pi })
```

```{r}
print(x)
```

Can be done by changing the `rebuild` global option.

```{r script_rebuild, eval=FALSE}
library(LittleThumb)

LittleThumb(rootpath = "AutoSaved")
LittleThumb(rebuild = T)

MakeObj(x, {
  message("building object x...")
  x <- 2 * pi
})
```

Can be done by specifying the `rebuild` argument when calling `MakeObj`.

```{r eval=FALSE}
library(LittleThumb)

LittleThumb(rootpath = "AutoSaved")

MakeObj(x, rebuild = T, {
  message("building object x...")
  x <- 2 * pi
})
```

Second time execution forcing to rebuild the R object.

```{r eval=FALSE}
source("LT_Test.R")
```
```{r eval=TRUE, message=TRUE, echo=FALSE, results='hide', ref.label='script_rebuild'}
```

```{r}
print(x)
```

```{r include=FALSE}
do.call(LittleThumb, cfg) # Restore default options
```

```{r include=FALSE}
# Cleanup
unlink("AutoSaved", recursive = T)
LittleThumb::ResetOptions()
DeleteObj(x)
```

